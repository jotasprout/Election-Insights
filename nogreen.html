<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">

        <meta name='viewport' content='user-scalable=no, width=device-width, initial-scale=1' />
        <meta name='apple-mobile-web-app-capable' content='yes'>
        <meta name='mobile-web-app-capable' content='yes'> 

        <script src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
        <script src='https://d3js.org/d3.v4.min.js'></script>
        <script src='states.js'></script>
        <link rel='stylesheet' type='text/css' href='prezStyle.css'>
    </head>
    <body>
        <script>

            // Width and Height
            const w = 1000;
            const h = 750;

            // Map projection
            const projection = d3.geoAlbersUsa()
                                 .translate([w/2, h/2])
                                 .scale([1000]);

            // Path Generator
            const path = d3.geoPath()
                           .projection(projection);

            // Create SVG
            const svg = d3.select("body")
                          .append("svg")
                          .attr("width", w)
                          .attr("height", h);

            let winners = [];

            // console.log(states);

            fetch(`getSocialistResultsNoGreen.php`).then(function(response){
                return response.json();
            }).then(function(response){
                // console.log(response);
                states.forEach(function (state){
                    let stateCandidates = response.filter(function (candidateResult){
                        return candidateResult.stateAbbr === state;
                    })

                    let stateWinner = stateCandidates.reduce((max, candidate) => max && max.popVotes > candidate.popVotes ? max : candidate, null);

                    if (stateWinner.popVotes == 0) {
                        console.log (stateWinner.stateName + " has no votes or candidates");

                        stateWinner = {
                            'stateName': stateWinner.stateName,
                            'popVotes': 0,
                            'candidateName': 'None',
                            'candidateID': 0,
                            'stateAbbr': stateWinner.stateAbbr
                        };
                    };
                    
                    console.log (stateWinner);
                    winners.push(stateWinner);
                });

               // console.log(winners);

// Get geoJSON
d3.json("myPrezData/us-states.json", function(json) {

    //Merge the ag. data and GeoJSON
    //Loop through once for each ag. data value
    for (var i = 0; i < winners.length; i++) {
        // Get the state name
        let dataState = winners[i].stateName;
        // console.log("first winners state is " + dataState);
        // Get winning candidate
        let dataWinner = winners[i].candidateID;
        // console.log(dataWinner + " won " + dataState);
        //Find the corresponding state inside the GeoJSON
        for (var j = 0; j < json.features.length; j++) {
            let jsonState = json.features[j].properties.name;
            if (dataState == jsonState) {
               // console.log(dataState + " equals " + jsonState);
                json.features[j].properties.winner = dataWinner;
            }
            else {
               // console.log(dataState + " does not equal " + jsonState);
            }
        }
    }

   // console.log(json);                

    //Bind data and create one path per GeoJSON feature
    svg.selectAll("path")
        .data(json.features)
        .enter()
        .append("path")
        .attr("d", path)
        .style("stroke", "#e0e0e0")
        .attr("class", function(d) {
            let value = d.properties.winner;
            switch (value) {
                case '28':
                    return "#jill-stein"; // Jill Stein
                    break;
                case '17':
                    return "gloria-estelalariva"; // Gloria Estela La Riva
                    break;   
                case '12':
                    return "lynn-kahn"; // Lynn S. Kahn
                    break;
                case '13':
                    return "chris-keniston"; // Chris Keniston
                    break;
                case '14':
                    return "alyson-kennedy"; // Alyson Kennedy
                    break;   
                case '20':
                    return "michael-maturen"; // Michael A. Maturen
                    break;   
                case '22':
                    return "monica-moorehead"; // Monica Moorehead
                    break;
                case '27':
                    return "emidio-soltysik"; // Emidio Soltysik
                    break;       
                default:
                    return "nope";
                    break;  
                /* 
                case '30':
                    return "#7d7d7d"; // Dan R. Vacek -- not in winner results now
                    break;  
                case '31':
                    return "#000"; // Jerry White -- not in winner results now
                    break;
                case '18':
                    return "#f60"; // Bradford Lyttle -- not in winner results now
                    break;   
                */                           
            }
        });
}); 
                    
            });
        </script>
        <div id="controls">
                <form id="selectCandidates" action="" method="post">
                    <fieldset>
                        <legend>Select Candidates to Display</legend>
                        <div class="form-group">
                            
                            <input type="checkbox" id="jill-stein" name="candidates" value="jill-stein" checked>
                            <label for="jill-stein">Jill Stein</label>
                        </div>
                        <div class="form-group">
                            
                            <input type="checkbox" id="alyson-kennedy" name="candidates" value="alyson-kennedy" checked>
                            <label for="alyson-kennedy">Alyson Kennedy</label>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="chris-keniston" name="candidates" value="chris-keniston" checked>
                            <label for="chris-keniston">Chris Keniston</label>
                            
                        </div>
                        <div class="form-group">
                            
                            <input type="checkbox" id="roque-delafuente" name="candidates" value="roque-delafuente" checked>
                            <label for="roque-delafuente">Roque De La Fuente</label>
                        </div>                    
                    </fieldset>
                </form>
    
            </div>
            <div id="legend">
                <div class="candi-legend" id="jill-stein">
                    <div class="candi-box jill-stein"></div>
                    <div class="candi-name">Jill Stein</div>
                    
                </div>
                <div class="candi-legend" id="alyson-kennedy">
                    <div class="candi-box alyson-kennedy"></div>
                    <div class="candi-name">Alyson Kennedy</div>
                    
                </div>
                <div class="candi-legend" id="chris-keniston">
                    
                    <div class="candi-box chris-keniston"></div>
                    <div class="candi-name">Chris Keniston</div>
                </div>
                <div class="candi-legend" id="roque-delafuente">
                    
                    <div class="candi-box roque-delafuente"></div>
                    <div class="candi-name">Roque De La Fuente</div>
                </div>            
            </div>
    </body>
</html>